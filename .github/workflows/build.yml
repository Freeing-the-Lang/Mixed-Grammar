name: AllLang Meta Engine - Build & Run

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-run:
    name: Build & Run (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: false

    steps:

      # 1. Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------------------------------------
      # 2. Install g++
      # ------------------------------------------------

      # Linux (apt)
      - name: Install g++ (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ nlohmann-json3-dev

      # macOS (brew)
      - name: Install g++ (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install gcc nlohmann-json

      # Windows (MinGW)
      - name: Install g++ (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          choco install mingw --version=12.2.0 -y
          echo "PATH=C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin;$env:PATH" >> $env:GITHUB_ENV

      # ------------------------------------------------
      # 3. json.hpp 체크 (POWERshell 문법)
      # ------------------------------------------------
      - name: Check json.hpp
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          if (-Not (Test-Path "json.hpp")) {
            Write-Host "ERROR: json.hpp is missing"
            exit 1
          } else {
            Write-Host "json.hpp found."
          }

      # ------------------------------------------------
      # 4. Build AllLang Engine
      # ------------------------------------------------
      - name: Build AllLang
        run: |
          g++ -std=c++20 alllang.cpp -o alllang

      # ------------------------------------------------
      # 5. Run with langspec.json
      # ------------------------------------------------
      - name: Run AllLang
        shell: bash
        run: |
          ./alllang
