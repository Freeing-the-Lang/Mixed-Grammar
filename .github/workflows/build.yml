name: AllLang - Meta Build & Run

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-run:
    name: Build & Run (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: false

    steps:
      # 1) Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Install g++ (Linux + macOS)
      - name: Setup g++ on Linux/macOS
        if: runner.os != 'Windows'
        run: |
          sudo apt-get update || true
          sudo apt-get install -y g++ || true

      # 3) Install MinGW g++ (Windows)
      - name: Setup g++ on Windows
        if: runner.os == 'Windows'
        run: |
          choco install mingw -y
          echo "PATH=/c/ProgramData/chocolatey/lib/mingw/tools/install/mingw64/bin:$PATH" >> $GITHUB_ENV

      # 4) (필수) nlohmann-json 설치 (Linux/Mac)
      - name: Install nlohmann-json (Linux/MacOS)
        if: runner.os != 'Windows'
        run: |
          sudo apt-get update || true
          sudo apt-get install -y nlohmann-json3-dev || true

      # 5) (필수) Windows용 json.hpp 제공 (직접 포함 필요)
      - name: Copy json.hpp on Windows
        if: runner.os == 'Windows'
        run: |
          if not exist json.hpp (
            echo "Missing json.hpp (nlohmann json single header)"
            exit 1
          )

      # 6) Build AllLang C++ Engine
      - name: Build AllLang (g++)
        run: |
          g++ -std=c++20 alllang.cpp -o alllang

      # 7) Run with langspec.json
      - name: Run AllLang Engine
        run: |
          ./alllang
        shell: bash
